<?xml version="1.0" encoding="UTF-8"?>
<prompt>
  <metadata>
    <title>Implement Deck Generation Logic &amp; Queue</title>
    <phase>Onboarding &amp; Deck Creation</phase>
    <difficulty>high</difficulty>
    <estimated_time>90-120 minutes</estimated_time>
    <version>1.0</version>
    <last_updated>2025-11-21</last_updated>
    <prerequisites>
      <prerequisite>ONBOARDING_UI_PROMPT.xml implemented</prerequisite>
      <prerequisite>Card Generation AI service available</prerequisite>
    </prerequisites>
  </metadata>

  <thinking_configuration>
    <claude_extended_thinking>
      <enabled>true</enabled>
      <reasoning>
        Complex logic required to ensure "equitable power distribution" while maintaining theme flavor.
        Need to design a queue system that doesn't timeout serverless functions (Vercel limits).
      </reasoning>
      <budget_tokens>15000</budget_tokens>
      <expected_thinking_depth>
        Design a distribution algorithm for card stats (Cost/Power/Defense).
        Architect a background job pattern (or recursive function) for processing the queue.
      </expected_thinking_depth>
    </claude_extended_thinking>
  </thinking_configuration>

  <context>
    <project_info>
      <name>Mindspark Duel</name>
      <framework>Next.js 16 (App Router) + NeonDB</framework>
    </project_info>

    <objective>
      <primary>
        Implement the backend logic to generate a starter deck of 20 cards.
        The generation must be balanced (Power Curve) and biased towards the theme's problem type.
        Images should be generated in a queue to avoid timeouts.
      </primary>
      <success_criteria>
        <criterion>✅ Deck has 20 cards</criterion>
        <criterion>✅ Mana Curve is balanced (Bell curve around 3-4 mana)</criterion>
        <criterion>✅ Problem types match theme bias (e.g., 70% Math for Technomancer)</criterion>
        <criterion>✅ Generation handles timeouts/failures gracefully</criterion>
      </success_criteria>
    </objective>
  </context>

  <instructions>
    <step number="1">
      <title>Define Deck Templates</title>
      <thinking_guidance>
        Create a configuration object/file that defines the "Ideal Deck Structure".
        - Total Cards: 20
        - Cost Distribution: 1-2 (4 cards), 3-4 (8 cards), 5-6 (6 cards), 7+ (2 cards).
        - Theme Biases:
          - Technomancer: 70% Math, 15% Logic, 15% Science.
          - Grove Guardians: 70% Science, 15% Math, 15% Logic.
          - Arcane Scholars: 70% Logic, 15% Science, 15% Math.
      </thinking_guidance>
      <action>
        Create `src/lib/game/deck-templates.ts`.
      </action>
    </step>

    <step number="2">
      <title>Implement Generation Queue Logic</title>
      <thinking_guidance>
        Since image generation is slow, we can't do 20 cards in one request.
        Implement a system where `startDeckGeneration` creates 20 "Pending Card" records in DB with prompts but no images yet.
        Then, trigger a background process (or use Vercel Cron / recursive fetch) to process these pending cards one by one.
      </thinking_guidance>
      <action>
        Update `src/app/actions/deck.ts` to create placeholder cards.
        Create `src/app/api/cron/process-deck-queue/route.ts` (or similar) to process images.
      </action>
    </step>

    <step number="3">
      <title>Implement Balanced Stat Generation</title>
      <thinking_guidance>
        Write a helper function `generateCardStats(targetCost)` that returns Power/Defense values appropriate for the cost.
        Ensure variance so not all 3-cost cards are identical.
      </thinking_guidance>
      <action>
        Create `src/lib/game/balance.ts`.
      </action>
    </step>
  </instructions>

  <validation>
    <execution_checklist>
      <item>✅ Generated deck follows the defined Mana Curve</item>
      <item>✅ Problem types are correctly biased by theme</item>
      <item>✅ Queue processes cards without timing out</item>
    </execution_checklist>
  </validation>

  <output_format>
    <structure>
      <section name="execution_log">Steps taken</section>
      <section name="stats_analysis">Analysis of generated deck balance</section>
    </structure>
    <format>Markdown</format>
  </output_format>
</prompt>
