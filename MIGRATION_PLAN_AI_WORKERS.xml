<?xml version="1.0" encoding="UTF-8"?>
<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                              ‚ïë
‚ïë           MIGRACI√ìN COMPLETA A CLOUDFLARE WORKERS AI                         ‚ïë
‚ïë           Sistema de Generaci√≥n de Mazos con Flux 1 Schnell                 ‚ïë
‚ïë                                                                              ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

OBJETIVO:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Reemplazar completamente el sistema actual basado en Gemini API (limitado a 200
requests/d√≠a) por Cloudflare Workers AI usando:
  - Flux 1 Schnell para generaci√≥n de im√°genes (4.80 neurons/imagen)
  - Llama 3.1 8B Instruct para generaci√≥n de texto (~100 neurons/texto)

BENEFITS:
  ‚úÖ Sin rate limits diarios (10,000 Neurons/d√≠a gratuitos)
  ‚úÖ Sin fallbacks necesarios (sistema unificado)
  ‚úÖ Costo predecible: 60 cartas = 12,288 neurons = $0.14 si excede free tier
  ‚úÖ Latencia reducida (Workers edge deployment)

ESTADO ACTUAL:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
  ‚úÖ Image Worker: Deployed y funcional (Flux 1 Schnell)
  ‚ùå Text Worker: No implementado (sigue usando Gemini API)
  ‚ùå Problem Worker: No implementado
  ‚è≥ 60 cartas pendientes esperando procesamiento

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
-->

<prompt>
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- METADATA                                                                 -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <metadata>
    <title>Migraci√≥n Completa a Cloudflare Workers AI - Sistema de Generaci√≥n de Mazos</title>
    <phase>Migration & Optimization</phase>
    <difficulty>high</difficulty>
    <estimated_time>2.5 hours</estimated_time>
    <version>2.0</version>
    <last_updated>2025-01-24</last_updated>

    <prerequisites>
      <prerequisite>Wrangler CLI instalado y configurado</prerequisite>
      <prerequisite>Workers AI Image Generator ya deployed (https://mindspark-ai-image-generator.agusmontoya.workers.dev)</prerequisite>
      <prerequisite>Cloudflare account con AI binding activo</prerequisite>
      <prerequisite>Node.js 18+ con bun runtime</prerequisite>
      <prerequisite>Access a Neon PostgreSQL database</prerequisite>
    </prerequisites>

    <dependencies>
      <dependency>@cloudflare/workers-types</dependency>
      <dependency>wrangler</dependency>
      <dependency>Node.js 18+</dependency>
      <dependency>bun (package manager)</dependency>
    </dependencies>
  </metadata>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- THINKING CONFIGURATION                                                   -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <thinking_configuration>
    <claude_extended_thinking>
      <enabled>true</enabled>
      <reasoning>
        Esta es una migraci√≥n arquitect√≥nica cr√≠tica que requiere:
        1. An√°lisis de m√∫ltiples servicios Workers AI (Llama 3.1, Flux Schnell)
        2. Evaluaci√≥n de trade-offs entre performance, costo y reliability
        3. Dise√±o de estrategia de migraci√≥n sin downtime
        4. An√°lisis de compatibilidad con sistema actual (Drizzle ORM, Stack Auth, R2)
        5. Planificaci√≥n de rollback en caso de fallos

        Extended Thinking permitir√° comparar alternativas de implementaci√≥n,
        prever casos edge (NSFW filter, rate limits internos de Workers),
        y dise√±ar una arquitectura resiliente sin fallbacks complejos.
      </reasoning>
      <budget_tokens>20000</budget_tokens>
      <expected_thinking_depth>
        - Comparaci√≥n de modelos Workers AI (Llama 3.1 8B vs 70B vs alternativas)
        - An√°lisis de costo-beneficio (free tier vs paid usage)
        - Evaluaci√≥n de impactos en sistema downstream (R2 upload, DB writes)
        - Dise√±o de estrategia de testing incremental
        - Identificaci√≥n de riesgos y mitigaciones
      </expected_thinking_depth>
    </claude_extended_thinking>

    <gpt5_reasoning>
      <chain_of_thought>
        Para cada Worker creado:
        1. Analizar schema de request/response esperado
        2. Evaluar necesidad de retry logic vs fail-fast
        3. Determinar logging requirements para debugging
        4. Verificar CORS configuration para Next.js integration
        5. Justificar configuraci√≥n de AI model (num_steps, temperature, etc.)
      </chain_of_thought>

      <escape_hatches>
        <hatch>Si Llama 3.1 8B produce texto de baja calidad, escalar a Llama 3.1 70B (m√°s neurons) y documentar cambio</hatch>
        <hatch>Si Workers AI tiene downtime, mantener Gemini API key configurada pero comentada como backup de emergencia</hatch>
        <hatch>Si NSFW filter bloquea prompts v√°lidos frecuentemente, implementar prompt sanitization layer</hatch>
        <hatch>Si 60 cartas pendientes fallan, procesar en batches de 10 con delays para evitar throttling interno</hatch>
      </escape_hatches>

      <precision_requirements>
        - Response format debe coincidir EXACTAMENTE con interfaces TypeScript existentes
        - Environment variables deben usar EXACT naming (R2_ACCOUNT_ID, etc.)
        - Worker URLs deben usar HTTPS y dominios .workers.dev reales
        - Validation debe verificar que im√°genes suban a R2 antes de marcar success
      </precision_requirements>
    </gpt5_reasoning>

    <reasoning_checkpoints>
      <checkpoint step="1">Comparar Llama 3.1 8B vs 70B para card text generation (costo vs calidad)</checkpoint>
      <checkpoint step="3">Evaluar si problem generation necesita Worker separado o puede inline en card-generator</checkpoint>
      <checkpoint step="5">Analizar strategy para procesar 60 cartas: secuencial vs parallel con concurrency control</checkpoint>
    </reasoning_checkpoints>

    <thinking_output_format>
      Para cada decisi√≥n arquitect√≥nica:
      - Alternativas consideradas (bullet list)
      - Pros/Contras de cada una
      - Costo estimado en Neurons (si aplica)
      - Score de compatibilidad con sistema actual (1-10)
      - Recomendaci√≥n final con justificaci√≥n t√©cnica
    </thinking_output_format>
  </thinking_configuration>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- CONTEXT                                                                  -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <context>
    <project_info>
      <name>MindSpark Duel</name>
      <current_location>/Users/agustinmontoya/Projectos/MVPs/juego-cartas-educativo/mindspark-duel</current_location>
      <framework>Next.js 15.1.6 with App Router</framework>
      <status>MVP en desarrollo - Sistema de generaci√≥n bloqueado por Gemini rate limits</status>
    </project_info>

    <tech_stack>
      <frontend>Next.js 15 + React 19 + TypeScript</frontend>
      <backend>Next.js Server Actions + Cloudflare Workers AI</backend>
      <database>Neon PostgreSQL con Drizzle ORM</database>
      <storage>Cloudflare R2 (S3-compatible)</storage>
      <auth>Stack Auth (no Supabase)</auth>
      <ai>Gemini API (ACTUAL) ‚Üí Cloudflare Workers AI (TARGET)</ai>
    </tech_stack>

    <objective>
      <primary>
        Migrar completamente el sistema de generaci√≥n de mazos desde Gemini API
        (bloqueado por 200 RPD limit) a Cloudflare Workers AI, eliminando todos
        los fallbacks y consolidando en una arquitectura serverless unificada.

        Esto desbloquear√° la generaci√≥n de 60 cartas pendientes y permitir√°
        escalamiento futuro sin preocupaciones de rate limits diarios.
      </primary>

      <success_criteria>
        <criterion>‚úÖ 3 Workers AI deployed y funcionales (text, image, problem generation)</criterion>
        <criterion>‚úÖ card-generator.ts y deck-generator.ts usan exclusivamente Workers AI</criterion>
        <criterion>‚úÖ 60 cartas pendientes procesadas exitosamente con im√°genes en R2</criterion>
        <criterion>‚úÖ Build TypeScript pasa sin errores (bun run build)</criterion>
        <criterion>‚úÖ Costo total de migraci√≥n dentro de free tier (10,000 Neurons)</criterion>
        <criterion>‚úÖ Gemini API removido completamente del codebase (no fallbacks)</criterion>
        <criterion>‚úÖ Tests de integraci√≥n validados: generar 1 carta nueva end-to-end</criterion>
        <criterion>‚úÖ Documentaci√≥n actualizada con nueva arquitectura Workers AI</criterion>
      </success_criteria>
    </objective>
  </context>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- CURRENT STATE                                                            -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <current_state>
    <directory_structure>
      <![CDATA[
mindspark-duel/
‚îú‚îÄ‚îÄ workers/
‚îÇ   ‚îî‚îÄ‚îÄ ai-image-generator/         ‚úÖ DEPLOYED
‚îÇ       ‚îú‚îÄ‚îÄ src/index.ts             (Flux 1 Schnell)
‚îÇ       ‚îú‚îÄ‚îÄ wrangler.toml
‚îÇ       ‚îî‚îÄ‚îÄ package.json
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ lib/
‚îÇ       ‚îî‚îÄ‚îÄ ai/
‚îÇ           ‚îú‚îÄ‚îÄ card-generator.ts    ‚ö†Ô∏è  HYBRID (Gemini text + Workers image)
‚îÇ           ‚îú‚îÄ‚îÄ deck-generator.ts    ‚ùå Pure Gemini
‚îÇ           ‚îî‚îÄ‚îÄ problem-generator.ts ‚ùå Pure Gemini
‚îÇ
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îú‚îÄ‚îÄ process-all-pending-slow.ts ‚ö†Ô∏è  Uses card-generator (hybrid)
‚îÇ   ‚îî‚îÄ‚îÄ seed-achievements.ts         (No changes needed)
‚îÇ
‚îî‚îÄ‚îÄ db/
    ‚îî‚îÄ‚îÄ schema.ts                    (No changes needed)
      ]]>
    </directory_structure>

    <key_files>
      <file path="workers/ai-image-generator/src/index.ts">
        Worker deployed usando Flux 1 Schnell (@cf/black-forest-labs/flux-1-schnell).
        Retorna base64 image via JSON response.
        FUNCIONAL y PROBADO (715KB image generada).
      </file>

      <file path="src/lib/ai/card-generator.ts">
        HYBRID state:
        - generateImageWithGemini() ‚Üí USA Workers AI (Flux Schnell) ‚úÖ
        - generateCard() ‚Üí USA Gemini API para text generation ‚ùå

        Necesita migraci√≥n de generateCard() a Workers AI (Llama 3.1).
      </file>

      <file path="src/lib/ai/deck-generator.ts">
        Pure Gemini API - genera nombres de mazos y temas.
        Bajo volumen (3 decks procesados), no cr√≠tico para rate limits.
        Migrar despu√©s de card-generator.
      </file>

      <file path="src/lib/ai/problem-generator.ts">
        Pure Gemini API - genera problemas educativos.
        Usado por card-generator.ts.
        DEBE migrarse antes de procesar 60 cartas pendientes.
      </file>
    </key_files>

    <current_implementation>
      El sistema actual funciona as√≠:

      1. USER: Crea deck v√≠a UI ‚Üí deck-generator.ts (Gemini) genera nombre/tema
      2. SYSTEM: Crea 20 cartas con status='generating'
      3. FOR EACH CARD:
         a. card-generator.ts llama Gemini API para card data (name, stats, imagePrompt)
         b. problem-generator.ts llama Gemini API para educational problem
         c. generateImageWithGemini() llama Workers AI (Flux Schnell) ‚úÖ
         d. uploadImage() sube a Cloudflare R2
         e. DB update con imageUrl + card data

      PROBLEMA: Pasos 3a y 3b hitting Gemini 200 RPD limit ‚Üí 60 cartas stuck.

      SOLUCI√ìN: Migrar 3a y 3b a Workers AI ‚Üí No rate limits.
    </current_implementation>
  </current_state>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- REQUIREMENTS                                                             -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <requirements>
    <technical>
      <requirement priority="critical">NO FALLBACKS - Usuario expl√≠citamente rechaz√≥ fallbacks: "si, no quiero mas fucking fallbacks"</requirement>
      <requirement priority="critical">TypeScript interfaces existentes NO deben cambiar (Card, Deck, Problem types)</requirement>
      <requirement priority="critical">R2 upload flow debe mantenerse id√©ntico (uploadImage() sin cambios)</requirement>
      <requirement priority="high">Workers deben retornar JSON con estructura EXACTA esperada por Next.js</requirement>
      <requirement priority="high">CORS headers configurados para permitir requests desde localhost:3000 y producci√≥n</requirement>
      <requirement priority="medium">Logging detallado en Workers para debugging (console.log visible en wrangler tail)</requirement>
      <requirement priority="medium">Environment variables organizadas (R2_*, CLOUDFLARE_*)</requirement>
      <requirement priority="low">Considerar batch processing si Workers AI tiene internal throttling</requirement>
    </technical>

    <functional>
      <requirement>Generar card data (name, description, stats, element, imagePrompt) usando Llama 3.1</requirement>
      <requirement>Generar educational problems (question, answer, category) usando Llama 3.1</requirement>
      <requirement>Procesar 60 cartas pendientes sin manual intervention</requirement>
      <requirement>Validar que cartas generadas tienen calidad similar a Gemini output</requirement>
    </functional>

    <non_functional>
      <requirement>Response time total por carta &lt; 30 segundos (Gemini era ~10s/carta)</requirement>
      <requirement>Costo total dentro de free tier 10,000 Neurons si posible</requirement>
      <requirement>Zero downtime durante migraci√≥n (deploy incremental)</requirement>
    </non_functional>
  </requirements>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- CONSTRAINTS                                                              -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <constraints>
    <constraint type="backwards_compatibility">
      Database schema NO puede cambiar - 60 cartas pendientes ya existen con
      status='generating'. Script debe trabajar con schema actual.
    </constraint>

    <constraint type="budget">
      Priorizar free tier (10,000 Neurons/d√≠a). 60 cartas estimadas en 12,288
      Neurons = $0.14 si excede. Acceptable pero documentar costo.
    </constraint>

    <constraint type="api_limits">
      Workers AI tiene l√≠mites internos no documentados. Implementar retry logic
      simple (max 3 retries con exponential backoff) para Workers requests.
    </constraint>

    <constraint type="user_mandate">
      "si, no quiero mas fucking fallbacks" - Usuario rechaz√≥ expl√≠citamente
      fallback logic. Sistema debe fallar r√°pido y claro si Workers AI no responde.
    </constraint>
  </constraints>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- INSTRUCTIONS (continuar√° en siguiente mensaje debido a l√≠mite...)        -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <instructions>
    <step number="1">
      <title>Crear Worker para Text Generation (Card Data) con Llama 3.1 8B</title>
      <action>Implementar Workers AI text generator completo con deploy y testing</action>
      <expected_output>Worker deployed y funcional retornando card data JSON v√°lido</expected_output>
    </step>

    <step number="2">
      <title>Crear Worker para Problem Generation con Llama 3.1 8B</title>
      <action>Implementar Workers AI problem generator con deploy y testing</action>
      <expected_output>Worker deployed retornando educational problems en espa√±ol</expected_output>
    </step>

    <step number="3">
      <title>Migrar card-generator.ts para usar Workers AI exclusivamente</title>
      <action>Refactorizar c√≥digo para remover Gemini y usar Workers AI</action>
      <expected_output>Build TypeScript exitoso sin errores</expected_output>
    </step>

    <step number="4">
      <title>Test End-to-End: Generar 1 Carta Nueva con Workers AI Completo</title>
      <action>Ejecutar test script validando full pipeline</action>
      <expected_output>Carta generada con imagen en R2 accesible</expected_output>
    </step>

    <step number="5">
      <title>Procesar 60 Cartas Pendientes con Workers AI (Batch Processing)</title>
      <action>Ejecutar batch processing con concurrency control</action>
      <expected_output>60 cartas procesadas con success rate &gt; 90%</expected_output>
    </step>

    <step number="6">
      <title>Cleanup: Remover Gemini API y Actualizar Documentaci√≥n</title>
      <action>Limpiar c√≥digo legacy y documentar nueva arquitectura</action>
      <expected_output>Codebase sin referencias a Gemini, docs actualizados</expected_output>
    </step>
  </instructions>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- VALIDATION                                                               -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <validation>
    <execution_checklist>
      <item>‚úÖ 3 Workers AI deployed y funcionales (text, image, problem generation)</item>
      <item>‚úÖ card-generator.ts migrado completamente sin referencias a Gemini API</item>
      <item>‚úÖ Build TypeScript exitoso sin errores (bun run build exit code 0)</item>
      <item>‚úÖ Test end-to-end genera 1 carta nueva con imagen en R2 accesible</item>
      <item>‚úÖ 60 cartas pendientes procesadas con &gt;90% success rate</item>
      <item>‚úÖ Costo total dentro de presupuesto (12,288 Neurons documentado)</item>
      <item>‚úÖ .env.example actualizado con Workers URLs, Gemini key deprecated</item>
      <item>‚úÖ Documentation actualizada (README.md, WORKERS_AI_ARCHITECTURE.md)</item>
      <item>‚úÖ No fallbacks implementados (user requirement)</item>
      <item>‚úÖ All decks marcados como 'completed' en database</item>
    </execution_checklist>
  </validation>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- OUTPUT FORMAT                                                            -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <output_format>
    <format>
      Markdown con:
      - Clear section headers (##)
      - Code blocks para commands/outputs
      - Tables para Workers list y cost analysis
      - Emoji indicators para visual scanning (‚úÖ‚ùåüìäüí∞‚è±Ô∏è)
    </format>
  </output_format>
</prompt>
