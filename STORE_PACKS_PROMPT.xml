<?xml version="1.0" encoding="UTF-8"?>
<prompt>
  <metadata>
    <title>Implement Store &amp; Pack Opening System</title>
    <phase>Engagement &amp; Progression</phase>
    <difficulty>high</difficulty>
    <estimated_time>150-180 minutes</estimated_time>
    <version>1.0</version>
    <last_updated>2025-11-21</last_updated>
    <prerequisites>
      <prerequisite>Gamification (Sparks) implemented</prerequisite>
      <prerequisite>Card generation working</prerequisite>
    </prerequisites>
  </metadata>

  <thinking_configuration>
    <claude_extended_thinking>
      <enabled>true</enabled>
      <reasoning>
        The monetization/reward loop. Users spend "Sparks" to get "Packs".
        Need a "Gacha" mechanic with weighted probabilities for rarity.
        Need a "Pity Timer" to guarantee high-rarity drops after X failures.
        Visual feedback (pack opening animation) is crucial for satisfaction.
      </reasoning>
      <budget_tokens>15000</budget_tokens>
      <expected_thinking_depth>
        Design the rarity weights (Common: 60%, Uncommon: 30%, Rare: 8%, Epic: 1.9%, Legendary: 0.1%).
        Implement the Pity Timer logic (store `packs_opened_since_last_epic` in DB).
        Plan the "Pack Opening" UI: 3 cards revealed one by one with visual flair (borders).
      </expected_thinking_depth>
    </claude_extended_thinking>
  </thinking_configuration>

  <context>
    <project_info>
      <name>Mindspark Duel</name>
      <description>Store and Pack Opening mechanics.</description>
    </project_info>

    <objective>
      <primary>
        Implement the **Arcane Library** (Store) where users spend Sparks to research **Tomes** (Packs).
        **Thematic Packs ("Tomes")**:
        - **Tome of Elements**: Higher chance for Elemental cards (Fire, Water, etc.).
        - **Tome of Logic**: Higher chance for Logic/Math cards.
        - **Standard Tome**: Balanced mix.
        
        **Mechanics**:
        - **Cost**: X Sparks per Tome.
        - **Contents**: 3 Cards.
        - **Guaranteed**: 1 Normal, 1 Uncommon.
        - **Variable**: 3rd card is Rare/Epic/Legendary.
        - **Pity System**: Guaranteed Epic+ after 10 tomes without one.
      </primary>
      <success_criteria>
        <criterion>✅ "Arcane Library" UI allows researching (buying) Tomes</criterion>
        <criterion>✅ Sparks are deducted correctly</criterion>
        <criterion>✅ Tome logic respects thematic weights (e.g., Logic Tome gives more Logic cards)</criterion>
        <criterion>✅ Visuals are magical (opening a book/scroll instead of a foil pack)</criterion>
      </success_criteria>
    </objective>
  </context>

  <instructions>
    <step number="1">
      <title>Database &amp; Rarity Logic</title>
      <thinking_guidance>
        Update `cards` table: Add `rarity` enum.
        Update `users` table: Add `pity_counter`.
        Create `src/lib/game/rarity-system.ts`: Logic to determine card rarity.
      </thinking_guidance>
      <action>
        Update schema and implement rarity logic.
      </action>
    </step>

    <step number="2">
      <title>Tome Generation Service</title>
      <thinking_guidance>
        Create Server Action `researchTome(tomeType)`.
        1. Check balance. Deduct Sparks.
        2. Generate 3 cards.
           - Apply **Thematic Bias** based on `tomeType` (e.g., if Logic Tome, 70% chance of Logic category).
        3. Add cards to `user_cards`.
        4. Update Pity Counter.
      </thinking_guidance>
      <action>
        Implement `researchTome` server action.
      </action>
    </step>

    <step number="3">
      <title>Library &amp; Opening UI</title>
      <thinking_guidance>
        Create `src/app/dashboard/library/page.tsx`.
        **Tome Selection**: Display different books/scrolls to choose from.
        **Opening Animation**:
        - Show an ancient book opening or a scroll unrolling.
        - Reveal cards with magical effects.
      </thinking_guidance>
      <action>
        Implement the Library and Opening experience.
      </action>
    </step>
  </instructions>

  <validation>
    <execution_checklist>
      <item>✅ Can buy pack with Sparks</item>
      <item>✅ Cannot buy if insufficient funds</item>
      <item>✅ Cards are added to collection</item>
      <item>✅ Pity timer works (guarantees drop eventually)</item>
    </execution_checklist>
  </validation>

  <output_format>
    <structure>
      <section name="execution_log">Steps taken</section>
      <section name="verification">Verification results</section>
    </structure>
    <format>Markdown</format>
  </output_format>
</prompt>
